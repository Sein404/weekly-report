# arch Linux安装指南

> 本文配图尚未完成,~~自己装的时候没想着要写教程,~~等我帮别人装完linux再配图吧()

这是一篇基于我的安装经验所写的用`EFI`引导的电脑安装`Arch Linux`（双系统）的中文简明教程，首先感谢鲨鱼姐姐的这篇<a href="https://github.com/JunkFood02/Arch-Linux-Installation-Guide">教程</a>。~~（感觉完全在照搬）~~

鉴于我在安装中遇到的一些痛苦的问题，我会尽可能的在每一步中写下补救措施以供参考。~~如果出错建议直接重装~~

> 说明：下文步骤中如遇难以解决的bug建议查看官方指南或者Google，学习使用工具解决问题也是一项非常重要的技能。

## Arch Linux难点

- 采用命令行安装，安装过程较为繁琐

- 操作时遇到问题较难解决，有些问题哪怕你去Linux社区也难以解决
- 安装教程大多为英文，对于英文基础弱或不适应英文环境的人很不友好

## 安装前准备

1. 大于100G的硬盘空余空间
2. 一块储存空间至少为4G的U盘
3. 稳定，而不需要额外进行设备认证的有线/无线网络连接，如手机热点等。
4. 至少三小时左右的时间乃至数星期的空余时间
5. 强大的心理素质
6. ~~找大佬带~~

## 安装介质准备

> 默认你使用的windows系统，如果你是Mac系统请自行搜索教程

1. 下载最新的arch Linux系统镜像，在<a href="https://archlinux.org/download/">这里</a>找到China的镜像源，如`tuna.tsinghua.edu.cn`下载`iso`镜像文件。
2. 下载

## 磁盘分区

> 任何有关磁盘的操作请务必小心谨慎，数据无价。如果你用`Bitlocker`等工具对磁盘进行了锁定，请先解除

- 在windows下空出一块分区进行安装，使用Windows自带的管理工具即可

1. 右键windows图标，在菜单中选择磁盘管理（此处默认为win11）

   ![](https://typora-1318125061.cos.ap-nanjing.myqcloud.com/typora/202305062320115.png)

2. 右击想要删除的分区，选择删除卷（注意提前备份其中的有用数据）

- 空闲的磁盘（新磁盘）：无需进行任何操作



不要在这里进行创建新分区的操作，进入Linux安装界面后会通过命令行完成

## BIOS设置

不同品牌的主板进入BIOS方法不同，请自行搜索

（首先忏悔我买了七彩虹将星BIOS非常难用）

然后按照以下步骤进行准备工作

1. 关闭`Secure Boot`，`Arch Linux`无法使用这个启动，你可以在安装完成后启用此功能
2. 某些品牌（如戴尔）可能默认在非windows系统关闭网卡，在设置中启用`Enable UEFI Network Stack`

## 开始安装Arch Linux

在完成以上设置之后，重启电脑，我们会进入Arch Linux的页面，选择第一个进入安装程序。加载完成进入命令行界面，恭喜你，希望接下来你预留了足够的时间在命令行界面折腾。

> 接下来的你将正式接触命令行页面，其中可能会有各种各样的bug。同样饱受debug之苦，我会尽可能的诠释每一步的原理方便随时debug。

## 一些命令行的基础操作

学一些命令行的基础操作可以让你的操作轻松一些

|       按键       | 作用                   |
| :--------------: | ---------------------- |
|      `Tab`       | 自动补全当前命令       |
|     `Ctrl+C`     | 中止当前正在执行的命令 |
| `↑` `（Ctrl+P）` | 显示上一条命令         |
| `↓` `（Ctrl+N）` | 显示下一条命令         |

## 连接网络和更新系统时间

解除可能存在的软硬件锁定

```
rfkill unblock all
```

#### 有线网连接

接入网线后，执行命令进行连接

```
dhcpcd
```

测试网络是否接通

```
ping www.baidu.com
```

> 确认连通后此处可以使用`Ctrl+C`来中止该命令

#### 无线网连接

列出当前网络设备

```
ip link show
```

> 无线网卡默认名称一般为`wlan0`，以下命令中的`wlan0`请替换为你的网卡名

若状态为`down`，需要将其设置为`up`

```
ip link set wlan0 up
```

执行下列命令进入`[iwd]`开头的网络操作环境

```
iwctl
```

接着列出当前可用的所有网卡设备

```
station wlan0 scan
```

执行下列命令列出扫描到的网络

```
station wlan0 get-networks
```

最后输入下列命令连接指定网络，然后输入密码

> `Wifi-SSID`请替换为你想要连接的网络
>
> 在命令行页面密码不会显示请注意

```
station wlan0 connect Wifi-SSID
```

使用`quit` 退出`iwc`，然后测试网络是否接通

```
ping www.baidu.com
```

#### 设置系统时间

```
timedatectl set-ntp true
```

> 请区分好`l`（字母）和`1`（数字），不然会变得不幸

## 分区与格式化

> <b>特别注意：一切涉及到硬盘的操作请勿必格外注意，在按下回车前请仔细检查自己是否存在错误，否则会造成数据丢失</b>

 #### 查看当前分区状况

```
fdisk -l
```

可以看到这里会显示你的所有硬盘及硬盘，形如`/dev/nvme0n1`（请以自己的设备为准）

- 如果你要在已有硬盘中安装，你会发现在硬盘中（安装windows的硬盘）发现一个类型为`EFI`的分区（请排除U盘中可能存在的`EFI`分区），这是你的引导分区，请记下路径（`/dev/nvme0n1p1`）

- 如果你要在新硬盘中安装，请执行以下命令

  1. 创建一个引导分区(将nvme0n1替换为你要操作的磁盘)

     ```
     fdisk /dev/nvme0n1
     ```

  2. 接下来你进入了`fdisk`的操作环境（可以输入h来查看指南）

     1. **如果你是一块全新的硬盘**：输入`g`来创建一个全新的gpt分区表，**否则直接进行第2步**。

     2. 输入`n`创建一个新的分区，首先会让你选择起始扇区，一般直接回车使用默认数值即可，然后可以输入结束扇区或是分区大小，这里我们输入`+512M`来创建一个`512M`的引导分区。

     3. 这时我们可以输入`p`来查看新创建的分区。

     4. 输入`t`并选择新创建的分区序号来更改分区的类型，输入`l`可以查看所有支持的类型，输入`ef`更改分区的类型为`EFI`。

     5. 输入`w`来将之前所有的操作写入磁盘生效，在这之前可以输入`p`来确认自己的分区表没有错误。

     6. 输入以下命令来格式化刚刚创建的引导分区(请将nvme0n1p1替换为刚创建的EFI分区)

        ```
        mkfs.fat -F32 /dev/nvme0n1p1
        ```

- 创建分区结束

#### 创建根分区

输入以下命令进入磁盘操作

```
fdisk /dev/nvme0n1
```

1. 输入n创建一个新的分区,首先选择起始扇区(回车默认即可),然后输入结束扇区(形如`121231`)或分区大小(形如`+200G`),如果想使分区大小占满剩余空间,可以直接回车默认.

2. 输入`p`查看新创建的分区,如有错误可以直接输入`q`退出重来确认无误后,

3. 输入`w`来将之前所有的操作写入磁盘生效

4. 输入以下命令格式化刚刚创建的根分区(将nvme0n1p2替换为你创建的根目录)

   ```
   mkfs.ext /dev/nvme0n1p2 
   ```

## 挂载分区

执行以下命令将根分区挂载到`/mnt`

```
mount /dev/nvme0n1p2
```

执行以下命令将引导文件挂载到上面

```
mkdir /mnt/boot
mount /dev/nvme0n1p1 /mnt/boot
```

> 挂载出错可以`↑`会到挂载命令并将`mount`改成`umount`取消挂载

## vim学习

在接下来的操作中将会用到`vim`,学习<a href=http://coolshell.cn/articles/5426.html>这篇教程</a>中的存活部分作为中场休息吧

## 选择镜像源

镜像源是我们下载软件包的来源,选择一个国内的镜像源将大幅提升你的下载速度



执行以下命令,进入`vim`来编辑镜像源文件

```
vim /etc/pacman.d/mirrorlist
```

找到标有China的镜像源,将其剪切粘贴到第一行,或者直接手输

推荐清华和浙大的镜像源

```
Server=http://mirrors.tuna.tsinghua.edu.cn/archlinux/$repo/os/$arch
Server = http://mirrors.zju.edu.cn/archlinux/$repo/os/$arch
```

最后按`Esc`回到normal模式后按`:wq`保存并推出

> 出问题了可以直接:q不保存退出后重进

## 安装基本包

接下来要安装`archlinux`基本包到到磁盘上.

```
pacstrap /mnt base base-devel linux linux-firmware dhcpcd vim reflector
```

接下来不断按`enter`就是了,~~反正你也看不懂这些~~

## 生成Fstab文件

Fstab文件用于自动挂载分区,输入下列命令生成

```
genfstab -L /mnt >> /mnt/etc/fstab
```

请输入下列命令检查生成是否正确

```
cat /mnt/etc/fstab
```

如果前面的挂载操作没有出错，应该输出且 **仅输出** 两条记录：（以你的磁盘分区情况为准）

- 根分区 `/` 被挂载到了此前建立的 **数据分区** `/dev/nvme0n1p2`，分区的文件系统为 `ext4`
- 引导分区 `/boot` 被挂载到了 **硬盘已有的 EFI 系统分区** `/dev/nvme0n1p1`，分区的文件系统为 `vfat`

如果`fatab`文件有任何错误,请输入下列命令删除并重复上述步骤

```
rm -rf /mnt/etc/fstab
```

## 系统的必要安装

#### Chroot

